<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moodify | Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="icon"  href="Home.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</head>

<body>
  <div class="dashboard-container">

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <h2 class="logo">ğŸŒ¿ Moodify</h2>

      <nav>
        <ul>
          <a href="homePage.html"><li class="active"> Home</li></a>
          <a href="WellnessTools.html"><li>Wellness Tools</li></a>
          <a href="Learn.html">  <li> Learn</li></a>
          <a href="#"><li id="logoutbtn" class="logout"> Logout</li></a>
        </ul>
      </nav>
    </aside>

    <!-- Main Dashboard -->
    <main class="main-content">

        <header class="topbar">
    <h2>Welcome back, <span id="username"></span> ğŸ‘‹</h2>
    <div class="profile-top">
      <!-- <img src="profile.jpg" alt="Profile Photo" id="profile-pic" class="profile-circle"> -->

 <div class="profile-wrapper">
      <img src="profile.jpg" alt="Profile Photo" id="profile-pic" class="profile-circle">
      <div class="profile-dropdown" id="profile-dropdown">
        <ul>
          <li id="view-profile">View Profile</li>
          <li id="upload-photo-option">Upload Photo</li>
        </ul>
      </div>
    </div>

    </div>
  </header>

  <!-- View Profile Modal -->
<!-- <div id="view-profile-modal" class="profile-modal">
  <div class="profile-modal-content" style="background:#fff; padding:25px; border-radius:20px; text-align:center;">
    <img id="view-profile-pic" src="profile.jpg" alt="Profile" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #8bc34a;">
    <button id="close-view-profile" style="margin-top:20px; background:#8bc34a; color:white; border:none; padding:8px 20px; border-radius:10px; cursor:pointer;">Close</button>
  </div>
</div> -->

<!-- View Profile Modal -->
<div id="view-profile-modal" class="profile-modal">
  <div class="profile-modal-content simple-profile">
    <button id="close-view-profile" class="close-btn">&times;</button>
    <img id="view-profile-pic" src="profile.jpg" alt="Profile" />
  </div>
</div>


<input type="file" id="upload-photo" accept="image/*" style="display:none">


<!-- Crop Modal -->
<div id="crop-modal" class="profile-modal">
  <div class="profile-modal-content" id="crop-content">
    <h3>Crop Your Profile Photo</h3>
    <img id="crop-image" style="max-width:100%; display:block; margin:auto; border-radius:10px;">
    <div style="margin-top:15px;">
      <button id="save-crop">Save</button>
      <button id="cancel-crop">Cancel</button>
    </div>
  </div>
</div>


  
      <!-- Welcome Section -->
      <section class="welcome">
        <h1>Hey <span id="username">Kumkum</span> ğŸ‘‹</h1>
        <p>How are you feeling today?</p>

        <div class="mood-selector">
          <button class="mood-btn">ğŸ˜Š</button>
          <button class="mood-btn">ğŸ˜</button>
          <button class="mood-btn">ğŸ˜</button>
        </div>
      </section>

      <!-- User Activity Overview -->
<section class="activity">
  <h2>Your Activity Overview</h2>
  <div class="activity-cards">
    <div class="activity-card">
      <h3>ğŸ§  Tests Taken</h3>
      <p id="tests-count">2</p>
    </div>
    <div class="activity-card">
      <h3>ğŸ“… Last Activity</h3>
      <p id="last-activity">24 Oct 2025</p>
    </div>
  </div>
</section>


      <!-- Test History -->
      <section class="history">
        <h2>Your Test History</h2>
        <table>
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Date Taken</th>
              <th>Result</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="test-history">
            <tr><td colspan="4">No data found yet</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Motivational Quote -->
      <section class="quote">
        <h2>Daily Motivation</h2>
        <p id="quote-text">"You are stronger than you think ğŸ’ª"</p>
      </section>

    </main>
  </div>
  
  
<script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("username");
  const userId = localStorage.getItem("userId");

  // ğŸ§± Redirect if not logged in
  if (!userId || !username) {
    alert("âš  Please log in to view your dashboard.");
    window.location.href = "LoginPage.html";
    return;
  }

  // Show username in the greeting
  document.querySelectorAll("#username").forEach(el => el.textContent = username);

  // ğŸ§± Fetch test data from backend
  const tableBody = document.getElementById("test-history");
  const testsCount = document.getElementById("tests-count");
  const lastActivity = document.getElementById("last-activity");

  tableBody.innerHTML = "<tr><td colspan='4'>Loading your test history...</td></tr>";

  fetch(`http://localhost:3000/api/test/get-tests/${userId}`)
    .then(res => res.json())
    .then(data => {
      // Clear old content
      tableBody.innerHTML = "";

      if (!data.tests || data.tests.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4'>No Data Found</td></tr>";
        testsCount.innerText = "0";
        lastActivity.innerText = "-";
        return;
      }

      // ğŸ§  Sort by date (latest first)
      const sortedTests = data.tests.sort((a, b) => new Date(b.date) - new Date(a.date));

      // ğŸ§¾ Fill test table
      sortedTests.forEach(t => {
        const date = new Date(t.date).toLocaleDateString();
        const row = `
          <tr>
            <td>${t.testName}</td>
            <td>${date}</td>
            <td>
              <span class="result-badge ${t.result.toLowerCase().split(' ')[0]}">${t.result}</span>
            </td>
            <td><button class="view-btn" onclick="viewTest('${t.testName}', '${t.score}', '${t.result}', '${date}')">View</button></td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });

      // ğŸ§© Update summary cards
      testsCount.innerText = sortedTests.length;
      lastActivity.innerText = new Date(sortedTests[0].date).toLocaleDateString();
    })
    .catch(err => {
      console.error("Error fetching test data:", err);
      tableBody.innerHTML = "<tr><td colspan='4'>âš  Error loading data.</td></tr>";
    });

  // Logout function
  document.getElementById("logoutbtn").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "homePage.html";
  });
});

// ğŸ§  Function to view test details (optional)
function viewTest(name, score, result, date) {
  alert(`ğŸ§  ${name}\nScore: ${score}\nResult: ${result}\nDate: ${date}`);
}


// ğŸ§­ Profile Dropdown Logic
const profilePic = document.getElementById("profile-pic");
const profileDropdown = document.getElementById("profile-dropdown");
const uploadOption = document.getElementById("upload-photo-option");
const uploadInput = document.getElementById("upload-photo");
const cropModal = document.getElementById("crop-modal");
const cropImage = document.getElementById("crop-image");
let cropper;

// Toggle dropdown when profile clicked
profilePic.addEventListener("click", (e) => {
  e.stopPropagation();
  profileDropdown.style.display = 
    profileDropdown.style.display === "block" ? "none" : "block";
});

// Hide dropdown when clicking outside
document.addEventListener("click", (e) => {
  if (!profileDropdown.contains(e.target) && e.target !== profilePic) {
    profileDropdown.style.display = "none";
  }
});


// View profile option
document.getElementById("view-profile").addEventListener("click", () => {
  const viewModal = document.getElementById("view-profile-modal");
  const profilePicSrc = document.getElementById("profile-pic").src;

  document.getElementById("view-profile-pic").src = profilePicSrc;

  viewModal.style.display = "flex";
  profileDropdown.style.display = "none";
});


// Close view profile modal
document.getElementById("close-view-profile").addEventListener("click", () => {
  document.getElementById("view-profile-modal").style.display = "none";
});


// Close modal when clicking outside content
window.addEventListener("click", (event) => {
  const viewModal = document.getElementById("view-profile-modal");
  if (event.target === viewModal) {
    viewModal.style.display = "none";
  }
});


//Upload photo option
uploadOption.addEventListener("click", () => {
  uploadInput.click();
  profileDropdown.style.display = "none";
});

// Crop and upload image
uploadInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    cropImage.src = event.target.result;
    cropModal.style.display = "flex";
    cropper = new Cropper(cropImage, {
      aspectRatio: 1,
      viewMode: 1,
      dragMode: "move"
    });
  };
  reader.readAsDataURL(file);
});

// Save cropped image
document.getElementById("save-crop").addEventListener("click", () => {
  const canvas = cropper.getCroppedCanvas({
  width: 500,
  height: 500,
  imageSmoothingEnabled: true,
  imageSmoothingQuality: 'high'
  });

  profilePic.src = canvas.toDataURL("image/png");
  cropModal.style.display = "none";
  cropper.destroy();
});

// Cancel crop
document.getElementById("cancel-crop").addEventListener("click", () => {
  cropModal.style.display = "none";
  cropper.destroy();
});

</script>

</body>
</html>