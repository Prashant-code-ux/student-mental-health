<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moodify | Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="icon"  href="Home.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</head>

<body>
  <div class="dashboard-container">

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <h2 class="logo">🌿 Moodify</h2>

      <nav>
        <ul>
          <a href="homePage.html"><li class="active"> Home</li></a>
          <a href="WellnessTools.html"><li>Wellness Tools</li></a>
          <a href="Learn.html">  <li> Learn</li></a>
          <a href="#"><li id="logoutbtn" class="logout"> Logout</li></a>
        </ul>
      </nav>
    </aside>

    <!-- Main Dashboard -->
    <main class="main-content">

        <header class="topbar">
    <h2>Welcome back, <span id="username"></span> 👋</h2>
    <div class="profile-top">
      <img src="profile.jpg" alt="Profile Photo" id="profile-pic" class="profile-circle">
    </div>
  </header>
      <!-- Welcome Section -->
      <section class="welcome">
        <h1>Hey <span id="username">Kumkum</span> 👋</h1>
        <p>How are you feeling today?</p>

        <div class="mood-selector">
          <button class="mood-btn">😊</button>
          <button class="mood-btn">😐</button>
          <button class="mood-btn">😞</button>
        </div>
      </section>

      <!-- User Activity Overview -->
<section class="activity">
  <h2>Your Activity Overview</h2>
  <div class="activity-cards">
    <div class="activity-card">
      <h3>🧠 Tests Taken</h3>
      <p id="tests-count">2</p>
    </div>
    <!-- <div class="activity-card">
      <h3>📈 Average Mood</h3>
      <p id="avg-mood">Happy 😊</p>
    </div> -->
    <div class="activity-card">
      <h3>📅 Last Activity</h3>
      <p id="last-activity">24 Oct 2025</p>
    </div>
  </div>
</section>


      <!-- Test History -->
      <section class="history">
        <h2>Your Test History</h2>
        <table>
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Date Taken</th>
              <th>Result</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="test-history">
            <tr><td colspan="4">No data found yet</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Motivational Quote -->
      <section class="quote">
        <h2>Daily Motivation</h2>
        <p id="quote-text">"You are stronger than you think 💪"</p>
      </section>

    </main>
  </div>
  <!-- Crop Image Modal -->
<div id="crop-modal" class="profile-modal">
  <div class="profile-modal-content" style="background:#fff; padding:15px; border-radius:15px;">
    <h3>Adjust Your Profile Picture</h3>
    <img id="crop-image" style="max-width:100%; border-radius:10px; margin-top:10px;">
    <div style="margin-top:15px;">
      <button id="save-crop">Save</button>
      <button id="cancel-crop" style="background:#ccc; color:#333; margin-left:10px;">Cancel</button>
    </div>
  </div>
</div>

  <input type="file" id="upload-photo" accept="image/*" style="display:none">
  
<script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("username");
  const userId = localStorage.getItem("userId");

  // 🧱 Redirect if not logged in
  if (!userId || !username) {
    alert("⚠️ Please log in to view your dashboard.");
    window.location.href = "LoginPage.html";
    return;
  }

  // Show username in the greeting
  document.querySelectorAll("#username").forEach(el => el.textContent = username);

  // 🧱 Fetch test data from backend
  const tableBody = document.getElementById("test-history");
  const testsCount = document.getElementById("tests-count");
  const lastActivity = document.getElementById("last-activity");

  tableBody.innerHTML = "<tr><td colspan='4'>Loading your test history...</td></tr>";

  fetch(`http://localhost:3000/api/test/get-tests/${userId}`)
    .then(res => res.json())
    .then(data => {
      // Clear old content
      tableBody.innerHTML = "";

      if (!data.tests || data.tests.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4'>No Data Found</td></tr>";
        testsCount.innerText = "0";
        lastActivity.innerText = "-";
        return;
      }

      // 🧠 Sort by date (latest first)
      const sortedTests = data.tests.sort((a, b) => new Date(b.date) - new Date(a.date));

      // 🧾 Fill test table
      sortedTests.forEach(t => {
        const date = new Date(t.date).toLocaleDateString();
        const row = `
          <tr>
            <td>${t.testName}</td>
            <td>${date}</td>
            <td>
              <span class="result-badge ${t.result.toLowerCase().split(' ')[0]}">${t.result}</span>
            </td>
            <td><button class="view-btn" onclick="viewTest('${t.testName}', '${t.score}', '${t.result}', '${date}')">View</button></td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });

      // 🧩 Update summary cards
      testsCount.innerText = sortedTests.length;
      lastActivity.innerText = new Date(sortedTests[0].date).toLocaleDateString();
    })
    .catch(err => {
      console.error("Error fetching test data:", err);
      tableBody.innerHTML = "<tr><td colspan='4'>⚠️ Error loading data.</td></tr>";
    });

  // Logout function
  document.getElementById("logoutbtn").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "homePage.html";
  });
});

// 🧠 Function to view test details (optional)
function viewTest(name, score, result, date) {
  alert(`🧠 ${name}\nScore: ${score}\nResult: ${result}\nDate: ${date}`);
}
</script>



</body>
</html>