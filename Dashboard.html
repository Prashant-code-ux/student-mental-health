<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moodify | Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="icon"  href="Home.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</head>

<body>
  <div class="dashboard-container">

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <h2 class="logo">🌿 Moodify</h2>

      <nav>
        <ul>
          <a href="homePage.html"><li class="active"> Home</li></a>
          <a href="WellnessTools.html"><li>Wellness Tools</li></a>
          <a href="Learn.html">  <li> Learn</li></a>
          <a href="#"><li id="logoutbtn" class="logout"> Logout</li></a>
        </ul>
      </nav>
    </aside>

    <!-- Main Dashboard -->
    <main class="main-content">

        <header class="topbar">
    <h2>Welcome back, <span id="username"></span> 👋</h2>
    <div class="profile-top">
      <img src="profile.jpg" alt="Profile Photo" id="profile-pic" class="profile-circle">
    </div>
  </header>
      <!-- Welcome Section -->
      <section class="welcome">
        <h1>Hey <span id="username">Kumkum</span> 👋</h1>
        <p>How are you feeling today?</p>

        <div class="mood-selector">
          <button class="mood-btn">😊</button>
          <button class="mood-btn">😐</button>
          <button class="mood-btn">😞</button>
        </div>
      </section>

      <!-- User Activity Overview -->
<section class="activity">
  <h2>Your Activity Overview</h2>
  <div class="activity-cards">
    <div class="activity-card">
      <h3>🧠 Tests Taken</h3>
      <p id="tests-count">2</p>
    </div>
    <!-- <div class="activity-card">
      <h3>📈 Average Mood</h3>
      <p id="avg-mood">Happy 😊</p>
    </div> -->
    <div class="activity-card">
      <h3>📅 Last Activity</h3>
      <p id="last-activity">24 Oct 2025</p>
    </div>
  </div>
</section>


      <!-- Test History -->
      <section class="history">
        <h2>Your Test History</h2>
        <table>
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Date Taken</th>
              <th>Result</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="test-history">
            <tr><td colspan="4">No data found yet</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Motivational Quote -->
      <section class="quote">
        <h2>Daily Motivation</h2>
        <p id="quote-text">"You are stronger than you think 💪"</p>
      </section>

    </main>
  </div>
  <!-- Crop Image Modal -->
<div id="crop-modal" class="profile-modal">
  <div class="profile-modal-content" style="background:#fff; padding:15px; border-radius:15px;">
    <h3>Adjust Your Profile Picture</h3>
    <img id="crop-image" style="max-width:100%; border-radius:10px; margin-top:10px;">
    <div style="margin-top:15px;">
      <button id="save-crop">Save</button>
      <button id="cancel-crop" style="background:#ccc; color:#333; margin-left:10px;">Cancel</button>
    </div>
  </div>
</div>

  <input type="file" id="upload-photo" accept="image/*" style="display:none">
  
<script>
document.addEventListener("DOMContentLoaded", () => {

  // Placeholder Test Data
  const testHistory = [
    { name: "Stress Test", date: "2025-10-20", result: "Moderate" },
    { name: "Anxiety Test", date: "2025-10-24", result: "Mild" }
  ];

  // Update Activity Stats
  document.getElementById("tests-count").innerText = testHistory.length;
  document.getElementById("last-activity").innerText = testHistory[testHistory.length - 1].date;

  // Fill Test Table
  const tableBody = document.getElementById("test-history");
  if (testHistory.length > 0) {
    tableBody.innerHTML = testHistory.map(t => `
      <tr>
        <td>${t.name}</td>
        <td>${t.date}</td>
        <td>${t.result}</td>
        <td><button class="view-btn">View</button></td>
      </tr>
    `).join('');
  }

  // Mood Charts
  const moodPieChart = new Chart(document.getElementById("moodPieChart"), {
    type: "pie",
    data: {
      labels: ["Happy", "Calm", "Anxious", "Sad"],
      datasets: [{
        data: [40, 30, 20, 10],
        backgroundColor: ["#91d4b6", "#a8e6cf", "#ffd6a5", "#ffb5a7"],
      }]
    },
    options: { responsive: true }
  });

  const moodLineChart = new Chart(document.getElementById("moodLineChart"), {
    type: "line",
    data: {
      labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      datasets: [{
        label: "Mood Level",
        data: [3, 4, 2, 5, 4, 3, 4],
        fill: true,
        borderColor: "#55b78a",
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });

  // Random Quote
  const quotes = [
    "You are stronger than you think 💪",
    "Small steps lead to big changes 🌈",
    "Breathe. You’ve got this 🌿",
    "It’s okay to take a break 🌸",
    "Progress, not perfection 🌻"
  ];
  document.getElementById("quote-text").innerText = 
    quotes[Math.floor(Math.random() * quotes.length)];

  // Profile Menu + Cropper
  const profilePic = document.getElementById("profile-pic");
  const uploadInput = document.getElementById("upload-photo");
  const optionBox = document.createElement("div");
  optionBox.classList.add("profile-options");
  optionBox.innerHTML = `
    <button id="view-profile">View Profile</button>
    <button id="upload-new">Upload Image</button>
  `;
  document.body.appendChild(optionBox);

  // Show option box
  profilePic.addEventListener("click", (event) => {
    event.stopPropagation();
    const rect = profilePic.getBoundingClientRect();
    const boxWidth = optionBox.offsetWidth || 160;
    const leftPosition = rect.left + window.scrollX + rect.width / 2 - boxWidth / 2;
    optionBox.style.top = `${rect.bottom + window.scrollY + 8}px`;
    optionBox.style.left =` ${leftPosition}px`;
    optionBox.classList.toggle("show");
  });

  document.addEventListener("click", () => optionBox.classList.remove("show"));

  optionBox.querySelector("#upload-new").addEventListener("click", (e) => {
    e.stopPropagation();
    optionBox.classList.remove("show");
    uploadInput.click();
  });

  // Cropper Setup
  let cropper;
  const cropModal = document.getElementById("crop-modal");
  const cropImage = document.getElementById("crop-image");
  const saveCropBtn = document.getElementById("save-crop");
  const cancelCropBtn = document.getElementById("cancel-crop");

  uploadInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        cropImage.src = reader.result;
        cropModal.style.display = "flex";
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropImage, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: "move",
          background: false,
          zoomOnWheel: true
        });
      };
      reader.readAsDataURL(file);
    }
  });


  saveCropBtn.addEventListener("click", () => {
  const canvas = cropper.getCroppedCanvas({
    width: 400,
    height: 400,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: "high",
  });
  const croppedImage = canvas.toDataURL("image/png", 1.0);
  profilePic.src = croppedImage;
  localStorage.setItem("profilePic", croppedImage); // ✅ Save image for homepage
  cropModal.style.display = "none";
  cropper.destroy();
});


  cancelCropBtn.addEventListener("click", () => {
    cropModal.style.display = "none";
    if (cropper) cropper.destroy();
  });

  // Profile View Modal
  const modal = document.createElement("div");
  modal.classList.add("profile-modal");
  modal.innerHTML = `
    <div class="profile-modal-content">
      <img id="modal-image" src="" alt="Profile Image" />
      <br><button id="close-modal">Close</button>
    </div>
  `;
  document.body.appendChild(modal);

  optionBox.querySelector("#view-profile").addEventListener("click", (e) => {
    e.stopPropagation();
    optionBox.classList.remove("show");
    const modalImage = document.getElementById("modal-image");
    modalImage.src = profilePic.src;
    modal.style.display = "flex";
  });

  document.getElementById("close-modal").addEventListener("click", () => {
    modal.style.display = "none";
  });

  modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.style.display = "none";
  });

});


// document.getElementById("logoutBtn").addEventListener("click", () => {
//     localStorage.removeItem("userLoggedIn");
//     localStorage.removeItem("userEmail");
//     window.location.href = "index.html";
//   });

document.getElementById("logoutbtn").addEventListener("click", () => {
  localStorage.removeItem("isLoggedIn");
  localStorage.removeItem("username");
   localStorage.removeItem("profilePic"); // ✅ remove saved profile image
  window.location.href = "homePage.html";
});

const username = localStorage.getItem("username");
if (username) {
  document.querySelectorAll("#username").forEach(el => el.textContent = username);
} else {
  window.location.href = "LoginPage.html";
}




document.addEventListener("DOMContentLoaded", () => {
  const userEmail = localStorage.getItem("userEmail");

  fetch(`http://localhost:5000/api/tests/${userEmail}`)
    .then((res) => res.json())
    .then((data) => {
      if (data.success) {
        const testHistory = data.results;
        const tableBody = document.getElementById("test-history");

        tableBody.innerHTML = testHistory
          .map(
            (test) => `
              <tr>
                <td>${test.testName}</td>
                <td>${new Date(test.date).toLocaleDateString()}</td>
                <td>${test.result}</td>
              </tr>`
          )
          .join("");
      }
    })
    .catch((err) => console.error(err));
});

</script>



</body>
</html>