<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moodify Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="icon"  href="Home.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</head>

<body>
  <div class="dashboard-container">

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <h2 class="logo">ðŸŒ¿ Moodify</h2>

      <nav>
        <ul>
          <a href="homePage.html"><li class="active"> Home</li></a>
          <a href="WellnessTools.html"><li>Wellness Tools</li></a>
          <a href="Learn.html">  <li> Learn More</li></a>
          <a href="#"><li id="logoutbtn" class="logout"> Logout</li></a>
        </ul>
      </nav>
    </aside>

    <!-- Main Dashboard -->
    <main class="main-content">

        <header class="topbar">
    <h2>Welcome back, <span id="username"></span> ðŸ‘‹</h2>
    <div class="profile-top">
 <div class="profile-wrapper">
      <img src="profile.jpg" alt="Profile Photo" id="profile-pic" class="profile-circle">
      <div class="profile-dropdown" id="profile-dropdown">
        <ul>
          <li id="view-profile">View Profile</li>
          <li id="upload-photo-option">Edit Profile</li>
        </ul>
      </div>
    </div>

    </div>
  </header>


<!-- View Profile Modal -->
<div id="view-profile-modal" class="profile-modal">
  <div class="profile-modal-content simple-profile">
    <button id="close-view-profile" class="close-btn">&times;</button>
    <img id="view-profile-pic" src="profile.jpg" alt="Profile" />
  </div>
</div>


<input type="file" id="upload-photo" accept="image/*" style="display:none">
<!-- Avatar Selection Modal -->
<div id="avatar-select-modal" class="profile-modal">
  <div class="profile-modal-content">
    <h3>Select Your Avatar</h3>
    <div class="avatar-grid">
      <img src="Avatar/avatar1.jpeg" class="avatar-option" alt="Avatar 1">
      <img src="Avatar/avatar2.jpeg" class="avatar-option" alt="Avatar 2">
      <img src="Avatar/avatar3.jpeg" class="avatar-option" alt="Avatar 3">
      <img src="Avatar/avatar4.jpeg" class="avatar-option" alt="Avatar 4">
      <img src="Avatar/avatar5.jpeg" class="avatar-option" alt="Avatar 5">
      <img src="Avatar/avatar6.jpeg" class="avatar-option" alt="Avatar 6">
      <img src="Avatar/avatar7.jpeg" class="avatar-option" alt="Avatar 7">
      <img src="Avatar/avatar8.jpeg" class="avatar-option" alt="Avatar 8">
      <img src="Avatar/avatar9.jpeg" class="avatar-option" alt="Avatar 9">
      <img src="Avatar/avatar10.jpeg" class="avatar-option" alt="Avatar 10">
      <img src="Avatar/avatar11.jpeg" class="avatar-option" alt="Avatar 11">
      <img src="Avatar/avatar12.jpeg" class="avatar-option" alt="Avatar 12">
    </div>
    <div class="modal-actions">
      <button id="save-avatar">Save</button>
      <button id="cancel-avatar">Cancel</button>
    </div>
  </div>
</div>

<!-- User Activity Overview -->
<section class="activity">
  <h2>Your Activity Overview</h2>
  <div class="activity-cards">
    <div class="activity-card">
      <h3>ðŸ§  Tests Taken</h3>
      <p id="tests-count">2</p>
    </div>
    <div class="activity-card">
      <h3>ðŸ“… Last Activity</h3>
      <p id="last-activity">24 Oct 2025</p>
    </div>
  </div>
</section>


<!-- Test History -->
<section class="history">
<h2>Your Test History</h2>
<table>
<thead>
<tr>
<th>Test Name</th>
<th>Date Taken</th>
<th>Result</th>
<th>View</th>
</tr>
</thead>
<tbody id="test-history">
<tr><td colspan="4">No data found yet</td></tr>
</tbody>
</table>
</section>

<section class="exercise-section">
  <h2>Your Exercises</h2>

  <div class="exercise-grid">

    <!-- Breathing -->
    <div class="exercise-box">
      <h3>Breathing Exercise</h3>
      <span class="type physical">Physical</span>
      <p>Last Done: <span id="breathing-date">Not done yet</span></p>
      <p>Time Taken: <span id="breathing-time">0</span> sec</p>
  <p>Total Breaths: <span id="breathing-breaths">0</span></p>
    </div>

    <!-- Grounding -->
    <div class="exercise-box">
      <h3>Grounding Exercise</h3>
      <span class="type physical">Physical</span>
      <p>Last Done: <span id="grounding-date">Not done yet</span></p>
      <p id="grounding-status" style="color: #2e8b57; font-weight: 600;"></p>
    </div>

    <!-- Feeling Wheel -->
    <div class="exercise-box">
      <h3>Interactive Feeling Wheel</h3>
      <span class="type mental">Mental</span>
      <p>Last Done: <span id="feeling-date">Not done yet</span></p>
       <p id="feeling-date"></p>
    </div>

    <!-- PM Exercise -->
    <div class="exercise-box">
      <h3>PMR Exercise</h3>
      <span class="type mental">Mental</span>
      <p>Last Done: <span id="pmr-date">Not done yet</span></p>
       <p id="pmr-session-msg" style="color:#2e8b57; font-weight:600;"></p>
    
    </div>

  </div>
</section>

<!-- My Mood Section -->
<section class="my-mood">
  <h2>My Mood</h2>

  <div class="mood-history-box">
    <p><strong>Today's Mood:</strong> <span id="today-mood">Not selected yet</span></p>
    <p><strong>Last Updated:</strong> <span id="mood-updated">--</span></p>
    

  </div>
</section>


<!-- Motivational Quote -->
<section class="quote">
<h2>Daily Motivation</h2>
<p id="quote-text">"You are stronger than you think ðŸ’ª"</p>
</section>

<!-- Test Result Modal -->
<div id="test-result-modal" class="test-modal">
  <div class="test-modal-content">
    <span id="close-test-modal" class="close-btn">&times;</span>
    <h3 id="test-modal-title">Test Result</h3>
    <p><strong>Test Name:</strong> <span id="modal-test-name"></span></p>
    <p><strong>Score:</strong> <span id="modal-test-score"></span></p>
    <p><strong>Result:</strong> <span id="modal-test-result"></span></p>
    <p><strong>Date:</strong> <span id="modal-test-date"></span></p>
  </div>
</div>


</main>
</div>
  
  <!-- footer -->
  <footer>
      <div class="footer-container">
        <div class="footer-col">
          <h3>Quick Links</h3>
          <a href="homePage.html" target="_blank">Home</a>
          <a href="About.html" target="_blank">About</a>
          <a href="Learn.html" target="_blank">Learn about mental health</a>
        </div>
        <div class="footer-col">
          <h3>Resources</h3>
          <a href="#">Blog</a>
           <a href="#">Self-Care Tips</a>
            <a href="#">Mental Health Guides</a>
        </div>
        <div class="footer-col">
          <h3>Contact</h3>
          <p>Email:support2moodify.com</p>
          <p>Phone: +91-1234567899</p>
        </div>
        </div>
        <div class="footer-bottom">
          <p>Made with ðŸ’š to support your mental health journey.</p>
        </div>
      
    </footer>  

<script>
document.addEventListener("DOMContentLoaded", () => {
  const username = localStorage.getItem("username");
  const userId = localStorage.getItem("userId");

  //  Redirect if not logged in
  if (!userId || !username) {
    alert("âš  Please log in to view your dashboard.");
    window.location.href = "LoginPage.html";
    return;
  }

  // Show username in the greeting
  document.querySelectorAll("#username").forEach(el => el.textContent = username);

  //  Fetch test data from backend
  const tableBody = document.getElementById("test-history");
  const testsCount = document.getElementById("tests-count");
  const lastActivity = document.getElementById("last-activity");

  tableBody.innerHTML = "<tr><td colspan='4'>Loading your test history...</td></tr>";

  fetch(`http://localhost:3000/api/test/get-tests/${userId}`)
    .then(res => res.json())
    .then(data => {
      // Clear old content
      tableBody.innerHTML = "";

      if (!data.tests || data.tests.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4'>No Data Found</td></tr>";
        testsCount.innerText = "0";
        lastActivity.innerText = "-";
        return;
      }

      //  Sort by date (latest first)
      const sortedTests = data.tests.sort((a, b) => new Date(b.date) - new Date(a.date));

      //  Fill test table
      sortedTests.forEach(t => {
        const date = new Date(t.date).toLocaleDateString();
        const row = `
          <tr>
            <td>${t.testName}</td>
            <td>${date}</td>
            <td>
              <span class="result-badge ${t.result.toLowerCase().split(' ')[0]}">${t.result}</span>
            </td>
            <td><button class="view-btn" onclick="viewTest('${t.testName}', '${t.score}', '${t.result}', '${date}')">View</button></td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });

      //  Update summary cards
      testsCount.innerText = sortedTests.length;
      lastActivity.innerText = new Date(sortedTests[0].date).toLocaleDateString();
    })
    .catch(err => {
      console.error("Error fetching test data:", err);
      tableBody.innerHTML = "<tr><td colspan='4'>âš  Error loading data.</td></tr>";
    });

  // Logout function
  document.getElementById("logoutbtn").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "homePage.html";
  });
});
// ðŸ§  Function to view test details (popup modal)
function viewTest(name, score, result, date) {
  document.getElementById("modal-test-name").textContent = name;
  document.getElementById("modal-test-score").textContent = score;
  document.getElementById("modal-test-result").textContent = result;
  document.getElementById("modal-test-date").textContent = date;

  document.getElementById("test-result-modal").style.display = "flex";
}

// Close popup when clicking X or outside
document.getElementById("close-test-modal").addEventListener("click", () => {
  document.getElementById("test-result-modal").style.display = "none";
});

window.addEventListener("click", (e) => {
  const modal = document.getElementById("test-result-modal");
  if (e.target === modal) {
    modal.style.display = "none";
  }
});
//  Profile Dropdown Logic
const profilePic = document.getElementById("profile-pic");
const profileDropdown = document.getElementById("profile-dropdown");
const uploadOption = document.getElementById("upload-photo-option");
const uploadInput = document.getElementById("upload-photo");
const cropModal = document.getElementById("crop-modal");
const cropImage = document.getElementById("crop-image");
let cropper;

// Toggle dropdown when profile clicked
profilePic.addEventListener("click", (e) => {
  e.stopPropagation();
  profileDropdown.style.display = 
    profileDropdown.style.display === "block" ? "none" : "block";
});

// Hide dropdown when clicking outside
document.addEventListener("click", (e) => {
  if (!profileDropdown.contains(e.target) && e.target !== profilePic) {
    profileDropdown.style.display = "none";
  }
});


// View profile option
document.getElementById("view-profile").addEventListener("click", () => {
  const viewModal = document.getElementById("view-profile-modal");
  const profilePicSrc = document.getElementById("profile-pic").src;

  document.getElementById("view-profile-pic").src = profilePicSrc;

  viewModal.style.display = "flex";
  profileDropdown.style.display = "none";
});


// Close view profile modal
document.getElementById("close-view-profile").addEventListener("click", () => {
  document.getElementById("view-profile-modal").style.display = "none";
});


// Close modal when clicking outside content
window.addEventListener("click", (event) => {
  const viewModal = document.getElementById("view-profile-modal");
  if (event.target === viewModal) {
    viewModal.style.display = "none";
  }
});

uploadOption.addEventListener("click", () => {
  avatarModal.style.display = "flex";
  profileDropdown.style.display = "none";
});
// Avatar Selection Logic
const avatarModal = document.getElementById("avatar-select-modal");
const avatarOptions = document.querySelectorAll(".avatar-option");
const saveAvatarBtn = document.getElementById("save-avatar");
const cancelAvatarBtn = document.getElementById("cancel-avatar");
let selectedAvatar = null;

// Select avatar
avatarOptions.forEach(avatar => {
  avatar.addEventListener("click", () => {
    avatarOptions.forEach(a => a.classList.remove("selected"));
    avatar.classList.add("selected");
    selectedAvatar = avatar.src;
  });
});

// Save selected avatar
saveAvatarBtn.addEventListener("click", () => {
  if (selectedAvatar) {
    profilePic.src = selectedAvatar;
    localStorage.setItem("userAvatar", selectedAvatar);
  }
  avatarModal.style.display = "none";
});

// Cancel avatar modal
cancelAvatarBtn.addEventListener("click", () => {
  avatarModal.style.display = "none";
});

// Load saved avatar on page load
window.addEventListener("DOMContentLoaded", () => {
  const savedAvatar = localStorage.getItem("userAvatar");
  if (savedAvatar) profilePic.src = savedAvatar;
}); 

const exerciseData = JSON.parse(localStorage.getItem("boxBreathingData")) || {};

// Load exercise dates from localStorage
document.getElementById("breathing-date").textContent =
  localStorage.getItem("breathingDate") || "Not done yet";

document.getElementById("breathing-breaths").textContent =
  localStorage.getItem("breathsTaken") || 0;

document.getElementById("breathing-time").textContent =
  localStorage.getItem("breathingTime") || 0;


document.getElementById("grounding-date").textContent =
  localStorage.getItem("groundingDate") || "Not done yet";

const groundingStatus = localStorage.getItem("groundingStatus");

if (groundingStatus) {
    document.getElementById("grounding-status").textContent = groundingStatus;
}
function loadGroundingData() {
  const userId = localStorage.getItem("userId");
  if (!userId) return;

  fetch(`http://localhost:3000/api/exercise/grounding/last/${userId}`)
    .then(res => res.json())
    .then(res => {
      if (res && res.session) {
        const session = res.session;
        document.getElementById("grounding-date").textContent = new Date(session.completedAt).toLocaleString();
        document.getElementById("grounding-status").textContent = session.message;
      } else {
        document.getElementById("grounding-date").textContent = "Not done yet";
        document.getElementById("grounding-status").textContent = "";
      }
    })
    .catch(err => {
      console.error("Error fetching grounding data:", err);
    });
}

// call it on dashboard load
document.addEventListener("DOMContentLoaded", () => {
  // ... your other load calls ...
  loadGroundingData();
});



document.getElementById("feeling-date").textContent =
  localStorage.getItem("feelingDate") || "Not done yet";
// Get last feeling message
const feelingMsg = localStorage.getItem("feelingMessage") || "No feeling recorded yet";
document.getElementById("feeling-date").textContent = feelingMsg;


document.getElementById("pmr-date").textContent =
  localStorage.getItem("pmrDate") || "Not done yet";

  // PMR Last Done
document.getElementById("pmr-date").textContent =
    localStorage.getItem("pmrDate") || "Not done yet";

// PMR Session Message
const pmrSession = localStorage.getItem("pmrSession");
document.getElementById("pmr-session-msg").textContent =
    pmrSession ? `Session ${pmrSession} completed successfully!` : "";

// Function to update today's mood section
function updateTodaysMood() {
  const moodData = JSON.parse(localStorage.getItem("moodHistory")) || [];
  if (moodData.length === 0) {
    document.getElementById("today-mood").textContent = "Not selected yet";
    document.getElementById("mood-updated").textContent = "--";
    return;
  }

  // Get the latest mood entry
  const latestMood = moodData[moodData.length - 1];
  document.getElementById("today-mood").textContent = `${latestMood.mood} - ${latestMood.note}`;
  document.getElementById("mood-updated").textContent = latestMood.date;
}

// Call it on page load
document.addEventListener("DOMContentLoaded", updateTodaysMood);

</script>

</body>
</html>